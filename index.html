<script>
d3.csv("AI Generated Essays Dataset.csv").then(data => {
  data.forEach(d => {
    d.generated = +d.generated;
    d.wordCount = d.text.split(/\s+/).length;
    let sentences = d.text.split(/[.!?]+/).filter(s => s.trim().length > 0);
    d.avgSentenceLength = sentences.length ? d.wordCount / sentences.length : 0;
  });

  const filterButtons = document.querySelectorAll(".filter-buttons button");
  let currentFilter = "all";

  filterButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      filterButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      currentFilter = btn.dataset.filter;
      updateDashboard();
    });
  });

  function getFilteredData() {
    if (currentFilter === "ai") return data.filter(d => d.generated === 1);
    if (currentFilter === "human") return data.filter(d => d.generated === 0);
    return data;
  }

  function updateDashboard() {
    const filtered = getFilteredData();

    const wcData = [
      {label: "AI", value: d3.mean(filtered.filter(d => d.generated === 1), d => d.wordCount) || 0},
      {label: "Human", value: d3.mean(filtered.filter(d => d.generated === 0), d => d.wordCount) || 0}
    ];
    drawBarChart("#wordCountChart svg", wcData, "#wordCountChart");

    const slData = [
      {label: "AI", value: d3.mean(filtered.filter(d => d.generated === 1), d => d.avgSentenceLength) || 0},
      {label: "Human", value: d3.mean(filtered.filter(d => d.generated === 0), d => d.avgSentenceLength) || 0}
    ];
    drawBarChart("#sentenceLengthChart svg", slData, "#sentenceLengthChart");

    drawCommonWords(filtered);

    drawPreviews(filtered);
  }

  function drawBarChart(svgSelector, dataArray, chartContainer) {
    const svg = d3.select(svgSelector);
    svg.selectAll("*").remove();
    const width = +svg.attr("width");
    const height = +svg.attr("height");
    const margin = {top: 20, right: 20, bottom: 30, left: 50};

    const x = d3.scaleBand().domain(dataArray.map(d => d.label))
      .range([margin.left, width - margin.right]).padding(0.3);

    const y = d3.scaleLinear().domain([0, d3.max(dataArray, d => d.value)]).nice()
      .range([height - margin.bottom, margin.top]);

    svg.append("g")
      .attr("transform", `translate(0,${height - margin.bottom})`)
      .call(d3.axisBottom(x));

    svg.append("g")
      .attr("transform", `translate(${margin.left},0)`)
      .call(d3.axisLeft(y));

    // Transition bars
    svg.selectAll(".bar")
      .data(dataArray)
      .join("rect")
      .attr("class", "bar")
      .attr("x", d => x(d.label))
      .attr("width", x.bandwidth())
      .attr("y", y(0))
      .attr("height", 0)
      .attr("fill", "#ff9800")
      .transition()
      .duration(800)
      .attr("y", d => y(d.value))
      .attr("height", d => y(0) - y(d.value));

    // Add annotation
    const topItem = dataArray.reduce((a, b) => a.value > b.value ? a : b);
    const annotationText = `${topItem.label} highest: ${topItem.value.toFixed(1)}`;

    d3.select(chartContainer).selectAll(".annotation").remove();
    d3.select(chartContainer)
      .append("div")
      .attr("class", "annotation")
      .style("color", "#ff9800")
      .style("font-size", "0.9em")
      .style("margin-top", "5px")
      .text(annotationText);
  }

  function drawCommonWords(filtered) {
    const aiText = filtered.filter(d => d.generated === 1).map(d => d.text).join(" ");
    const humanText = filtered.filter(d => d.generated === 0).map(d => d.text).join(" ");
    const allWords = (aiText + " " + humanText).toLowerCase().match(/\b[a-z]{3,}\b/g) || [];

    const freq = {};
    allWords.forEach(w => freq[w] = (freq[w] || 0) + 1);
    const topWords = Object.entries(freq).sort((a,b) => b[1]-a[1]).slice(0,10)
      .map(([word, count]) => ({label: word, value: count}));

    drawBarChart("#commonWordsChart svg", topWords, "#commonWordsChart");
  }

  function drawPreviews(filtered) {
    const container = d3.select("#essayPreviews");
    container.selectAll("*").remove();

    container.append("h4").style("font-size", "1.4em").style("font-weight", "bold").text("AI Essays");
    filtered.filter(d => d.generated === 1).slice(0, 10).forEach(e => addEssayPreview(container, e));

    container.append("h4").style("font-size", "1.4em").style("font-weight", "bold").text("Human Essays");
    filtered.filter(d => d.generated === 0).slice(0, 10).forEach(e => addEssayPreview(container, e));
  }

  function addEssayPreview(container, entry) {
    const div = container.append("div").attr("class", "essay");
    const preview = entry.text.slice(0, 200) + (entry.text.length > 200 ? "..." : "");
    const p = div.append("p").text(preview);
    if (entry.text.length > 200) {
      div.append("span")
        .attr("class", "toggle")
        .text("View full text")
        .on("click", function() {
          if (p.text() === preview) {
            p.text(entry.text);
            d3.select(this).text("Show less");
          } else {
            p.text(preview);
            d3.select(this).text("View full text");
          }
        });
    }
  }

  updateDashboard();
});
</script>
